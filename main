#!/bin/bash
#PBS -l nodes=1:ppn=4,vmem=16gb,walltime=8:00:00
#PBS -N app-add-roi-surface-vis

set -ex

# grab wmc inputs
classification=`jq -r '.classification' config.json`
tracts=`jq -r '.tracts' config.json`
surfaces=`jq -r '.surfaces' config.json`

# make output dir
[ ! -d ./wmc ] && mkdir -p ./wmc

# copy classification.mat
[ ! -f ./wmc/classification.mat ] && cp -v ${classification} ./wmc/classification.mat

# copy tracts jsons if there
if [ -d ${tracts} ]; then
	cp -R ${tracts} ./wmc/tracts
fi

# copy surface jsons if there. these will be added to by the rois2vtks.py function
if [ -d ${surfaces} ]; then
	cp -R ${surfaces} ./wmc/surfaces
else
	mkdir -p ./wmc/surfaces
fi

# generate surface ROIS for datatype viewer
if [ ! -f ./wmc/surfaces/index.json ]; then
	time singularity exec -e docker://brainlife/pythonvtk:1.1 ./rois2vtks.py
fi

# output check. if not empty, good. if empty, bad
if [ ! -z "$(ls -A ./wmc/surfaces)" ]; then
	echo "complete"
	exit 0
else
	echo "something failed."
	exit 1
fi
